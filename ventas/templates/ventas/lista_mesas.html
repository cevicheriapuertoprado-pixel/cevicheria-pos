{% extends 'base.html' %}

{% block content %}
<canvas id="particles-bg"></canvas>

<div class="dashboard-container py-5">

    <!-- Encabezado -->
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4">
        <h2 class="fw-bold text-white mb-3 mb-md-0">🪑 Mesas del Salón</h2>
        <a href="{% url 'dashboard' %}" class="btn btn-outline-light">
            ⬅ Volver al Dashboard
        </a>
    </div>

    <!-- Filtro de mesas -->
    <div class="mb-4 sticky-top buscador-wrapper">
        <input type="text" id="buscador-mesas" class="form-control form-control-lg"
               placeholder="🔍 Buscar mesa...">
    </div>

    <!-- Tarjetas de mesas -->
    <div class="row g-4" id="mesas-container">
        {% for info in mesas_info %}
        <div class="col-6 col-md-3 mesa-item">
            <div class="mesa-card {% if info.ocupada %}mesa-ocupada{% else %}mesa-libre{% endif %} text-center p-3 h-100">
                <i class="bi {% if info.ocupada %}bi-people-fill{% else %}bi-person{% endif %} fs-2 mb-2"></i>
                <div class="fs-5 fw-bold">Mesa {{ info.mesa.numero }}</div>
                <small>{% if info.ocupada %}Ocupada{% else %}Libre{% endif %}</small>

                <div class="mt-3">
                    {% if info.ocupada %}
                        {% if info.pedido_id %}
                        <a href="{% url 'detalle_pedido' info.pedido_id %}"
                           class="btn btn-sm btn-primary w-100 mb-2">
                            📋 Ver Pedido
                        </a>
                        {% endif %}
                        <a href="{% url 'liberar_mesa' info.mesa.id %}"
                           class="btn btn-sm btn-outline-danger w-100"
                           onclick="return confirm('¿Seguro que quieres liberar esta mesa?')">
                            🗑 Liberar
                        </a>
                    {% else %}
                        <a href="{% url 'abrir_mesa' info.mesa.id %}" class="btn btn-sm btn-success w-100">
                            ➕ Abrir Mesa
                        </a>
                    {% endif %}
                </div>
            </div>
        </div>
        {% empty %}
        <div class="col-12 text-center text-secondary">
            ⚠ No hay mesas registradas.
        </div>
        {% endfor %}
    </div>

</div>
{% endblock %}

{% block extra_css %}
<style>
body {
  background: #0b1522; /* Mismo color que el detalle de pedido */
  color: #fff;
  font-family: 'Poppins', sans-serif;
}

#particles-bg {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  z-index: 0;
  pointer-events: none;
}

.dashboard-container {
  position: relative;
  z-index: 1;
}

/* Buscador sticky */
.buscador-wrapper {
  top: 70px;
  background: #0b1522;
  z-index: 10;
  padding: 8px 0;
  border-bottom: 1px solid #1e2a38;
}

/* Tarjetas de mesas */
.mesa-card {
  border-radius: 1rem;
  font-weight: 600;
  font-size: 1.1rem;
  cursor: pointer;
  transition: transform 0.2s ease, box-shadow 0.2s ease;
  background: #1e2a38;
  color: #fff;
}
.mesa-card:hover {
  transform: scale(1.03);
  box-shadow: 0 0 12px rgba(0, 191, 255, 0.4);
}

/* Estado mesa */
.mesa-libre {
  border: 2px solid #39ff14;
  color: #39ff14;
}
.mesa-ocupada {
  border: 2px solid #ff2e2e;
  color: #ff2e2e;
}

.mesa-card i {
  display: block;
  margin: 0 auto;
  font-size: 2rem;
}

.mesa-card small {
  display: block;
  margin-top: 0.3rem;
  color: #ccc;
  font-size: 0.85rem;
}

@media (max-width:575px) {
  .mesa-card { font-size: 1rem; padding: 0.8rem; }
  .mesa-card i { font-size: 1.5rem; }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Buscador de mesas
document.addEventListener("DOMContentLoaded", () => {
    const buscador = document.getElementById("buscador-mesas");
    const mesas = document.querySelectorAll(".mesa-item");

    buscador.addEventListener("input", () => {
        const filtro = buscador.value.toLowerCase();
        mesas.forEach(item => {
            const texto = item.innerText.toLowerCase();
            item.style.display = texto.includes(filtro) ? "block" : "none";
        });
    });
});

// Partículas de fondo
const canvas = document.getElementById('particles-bg');
const ctx = canvas.getContext('2d');
let particles = [];

function resizeCanvas() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
window.addEventListener('resize', resizeCanvas);
resizeCanvas();

function initParticles(num=50){
  particles = [];
  for(let i=0;i<num;i++){
    particles.push({
      x: Math.random()*canvas.width,
      y: Math.random()*canvas.height,
      radius: Math.random()*2+1,
      color: ['#39ff14','#fffa00','#ff2e2e','#00bfff','#9966ff'][Math.floor(Math.random()*5)],
      dx: (Math.random()-0.5)*1,
      dy: (Math.random()-0.5)*1
    });
  }
}
initParticles();

function animateParticles(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  particles.forEach(p=>{
    p.x+=p.dx; p.y+=p.dy;
    if(p.x<0||p.x>canvas.width) p.dx*=-1;
    if(p.y<0||p.y>canvas.height) p.dy*=-1;
    ctx.beginPath();
    ctx.arc(p.x,p.y,p.radius,0,Math.PI*2);
    ctx.fillStyle=p.color;
    ctx.fill();
  });
  requestAnimationFrame(animateParticles);
}
animateParticles();
</script>
{% endblock %}
