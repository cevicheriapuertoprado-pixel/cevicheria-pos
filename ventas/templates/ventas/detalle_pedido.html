{% extends "base.html" %}

{% block content %}
<div class="container py-4">

  <!-- Encabezado -->
  <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4">
    <h2 class="neon-yellow glow">
      üçΩ {% if pedido.mesa %}Mesa {{ pedido.mesa.numero }}{% else %}Para llevar{% endif %} ‚Äî Pedido #{{ pedido.id }}
    </h2>
    <a href="{% url 'lista_mesas' %}" class="btn btn-outline-secondary neon-blue glow">
      ‚¨Ö Volver a Mesas
    </a>
  </div>

  <!-- Platos en el pedido -->
  <div class="mb-4">
    <h4 class="fw-bold text-light mb-3">üìã Platos en este pedido</h4>

    {% if pedido.detalles.all %}
      <ul class="list-group shadow rounded-3">
        {% for detalle in pedido.detalles.all %}
          <li class="list-group-item d-flex justify-content-between align-items-center">
            <div>
              <span class="fw-semibold">{{ detalle.plato.nombre }}</span>
              <small class="text-muted">(x{{ detalle.cantidad }})</small>
            </div>
            <div>
              <span class="fw-bold text-success">S/. {{ detalle.subtotal|floatformat:2 }}</span>
              {% if pedido.estado == "abierto" %}
                <a href="{% url 'quitar_plato' pedido.id detalle.plato.id %}" 
                   class="btn btn-outline-danger btn-sm ms-2">
                  ‚ùå Quitar
                </a>
              {% endif %}
            </div>
          </li>
        {% endfor %}
      </ul>

      <div class="mt-3 d-flex flex-wrap justify-content-end align-items-center gap-2">
        <h5 class="mb-0 me-3 text-light">
          üí∞ Total: <strong class="neon-yellow">S/. {{ pedido.total|floatformat:2 }}</strong>
        </h5>
        <a href="{% url 'imprimir_ticket' pedido.id 'cocina' %}" target="_blank" class="btn btn-outline-info btn-sm">
          üñ® Cocina
        </a>
        <a href="{% url 'imprimir_ticket' pedido.id 'cliente' %}" target="_blank" class="btn btn-outline-primary btn-sm">
          üßæ Cliente
        </a>
        {% if pedido.estado == "abierto" %}
          <a href="{% url 'cerrar_pedido' pedido.id %}" class="btn btn-danger btn-sm"
             onclick="return confirm('¬øCerrar este pedido y liberar la mesa?')">
            üîí Cerrar pedido
          </a>
        {% else %}
          <span class="badge bg-danger p-2"><i class="bi bi-lock-fill"></i> Pedido {{ pedido.estado }}</span>
        {% endif %}
      </div>
    {% else %}
      <p class="text-muted mt-2">‚ö† No hay platos en este pedido a√∫n.</p>
    {% endif %}
  </div>

  {% if pedido.estado == "abierto" %}
  <!-- Buscador sticky -->
  <div class="mb-3 sticky-top" style="top:80px; background:rgba(10,10,10,0.85); z-index:2; padding:10px 0;">
    <input type="text" id="buscador" class="form-control form-control-lg neon-input"
           placeholder="üîç Buscar plato o categor√≠a...">
  </div>

  <!-- Lista de platos agrupados por categor√≠a -->
  <div id="lista-platos" class="scroll-container">
    {% for categoria, platos_categoria in platos_por_categoria.items %}
    <div class="mb-4 categoria-section" id="cat-{{ categoria|slugify }}">
      <h4 class="fw-bold text-light border-start border-3 border-primary ps-2 categoria-title">
        <i class="bi bi-tags-fill text-primary me-2"></i>{{ categoria }}
      </h4>
      <div class="row g-3 mt-1">
        {% for plato in platos_categoria %}
        <div class="col-12 col-md-6 plato-item">
          <div class="card plato-card shadow border-0 mesa-card mesa-libre text-light">
            <div class="card-body d-flex justify-content-between align-items-center">
              <span class="fw-semibold">{{ plato.nombre }}</span>
              <span>
                <span class="text-info fw-bold">S/. {{ plato.precio|floatformat:2 }}</span>
                <a href="{% url 'agregar_plato' pedido.id plato.id %}" 
                   class="btn btn-success btn-sm ms-2">
                  ‚ûï
                </a>
              </span>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
    {% endfor %}
  </div>
  {% endif %}

</div>
{% endblock %}

{% block extra_css %}
<style>
/* Fondo est√°tico inspirado en logo */
body {
  background: linear-gradient(to bottom, #87CEEB 0%, #ffffff 50%, #FFD700 100%);
  background-attachment: fixed;
  color:#fff;
  font-family:'Poppins',sans-serif;
}

/* Scroll para lista de platos */
.scroll-container {
  max-height: 55vh;
  overflow-y: auto;
  padding-right: 5px;
  scrollbar-width: thin;
}

/* Tarjetas de plato */
.plato-card {
  background: rgba(0,0,0,0.7);
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}
.plato-card:hover {
  transform: scale(1.02);
  box-shadow: 0 0 15px rgba(0,191,255,0.8);
}

/* Lista de detalles */
.list-group-item {
  border-left: 4px solid #00bfff;
  background: rgba(0,0,0,0.8);
  transition: transform 0.2s ease, background 0.2s ease;
}
.list-group-item:hover { transform: translateX(4px); background:rgba(20,20,20,0.9); }
</style>
{% endblock %}

{% block extra_js %}
<script>
// Filtro de b√∫squeda
document.getElementById("buscador")?.addEventListener("input", function() {
  const filtro = this.value.toLowerCase();
  document.querySelectorAll(".categoria-section").forEach(sec => {
    let visible = false;
    const cards = sec.querySelectorAll(".plato-card");
    cards.forEach(card => {
      const nombre = card.innerText.toLowerCase();
      const categoria = sec.querySelector("h4").innerText.toLowerCase();
      if (nombre.includes(filtro) || categoria.includes(filtro)) {
        card.parentElement.style.display = "block";
        visible = true;
      } else {
        card.parentElement.style.display = "none";
      }
    });
    sec.style.display = visible ? "block" : "none";
  });
});
</script>
{% endblock %}
