{% extends "base.html" %}

{% block content %}
<canvas id="particles-bg"></canvas>

<div class="container py-5 position-relative" style="z-index:1;">

  <!-- Encabezado -->
  <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4">
    <h2 class="neon-yellow glow">
      üçΩ Mesa {{ pedido.mesa.numero }} ‚Äî Pedido #{{ pedido.id }}
    </h2>
    <a href="{% url 'lista_mesas' %}" class="btn btn-outline-secondary neon-blue glow">
      ‚¨Ö Volver a Mesas
    </a>
  </div>

  <!-- Platos del pedido -->
  <div class="mb-5">
    <h4 class="fw-bold text-light mb-3">
      üìã Platos en este pedido
    </h4>

    {% if pedido.detalles.all %}
      <ul class="list-group shadow rounded-3">
        {% for detalle in pedido.detalles.all %}
          <li class="list-group-item d-flex justify-content-between align-items-center bg-dark text-light">
            <div>
              <span class="fw-semibold">{{ detalle.plato.nombre }}</span>
              <small class="text-muted">(x{{ detalle.cantidad }})</small>
            </div>
            <div>
              <span class="fw-bold text-success">S/. {{ detalle.subtotal|floatformat:2 }}</span>
              {% if pedido.estado == "abierto" %}
                <a href="{% url 'quitar_plato' pedido.id detalle.plato.id %}" 
                   class="btn btn-outline-danger btn-sm ms-2">
                  ‚ùå Quitar
                </a>
              {% endif %}
            </div>
          </li>
        {% endfor %}
      </ul>

      <!-- Totales y acciones -->
      <div class="mt-4 d-flex flex-wrap justify-content-end align-items-center gap-2">
        <h5 class="mb-0 me-3 text-light">
          üí∞ Total: <strong class="neon-yellow">S/. {{ pedido.total|floatformat:2 }}</strong>
        </h5>

        <a href="{% url 'imprimir_ticket' pedido.id 'cocina' %}" target="_blank"
           class="btn btn-outline-info btn-sm">
          üñ® Cocina
        </a>
        <a href="{% url 'imprimir_ticket' pedido.id 'cliente' %}" target="_blank"
           class="btn btn-outline-primary btn-sm">
          üßæ Cliente
        </a>

        {% if pedido.estado == "abierto" %}
          <a href="{% url 'cerrar_pedido' pedido.id %}" class="btn btn-danger btn-sm"
             onclick="return confirm('¬øCerrar este pedido y liberar la mesa?')">
            üîí Cerrar pedido
          </a>
        {% else %}
          <span class="badge bg-danger p-2"><i class="bi bi-lock-fill"></i> Pedido cerrado</span>
        {% endif %}
      </div>

    {% else %}
      <p class="text-muted mt-2">
        ‚ö† No hay platos en este pedido a√∫n.
      </p>
    {% endif %}
  </div>

  {% if pedido.estado == "abierto" %}
  <!-- Buscador -->
  <div class="mb-4">
    <input type="text" id="buscador" class="form-control form-control-lg neon-input"
           placeholder="üîç Buscar en la carta...">
  </div>

  <!-- Lista de platos -->
  <div id="lista-platos" class="row g-3">
    {% for plato in platos %}
      <div class="col-12 col-md-6">
        <div class="card plato-item shadow border-0 mesa-card mesa-libre text-light">
          <div class="card-body d-flex justify-content-between align-items-center">
            <span class="fw-semibold">{{ plato.nombre }}</span>
            <span>
              <span class="text-info fw-bold">S/. {{ plato.precio|floatformat:2 }}</span>
              <a href="{% url 'agregar_plato' pedido.id plato.id %}" 
                 class="btn btn-success btn-sm ms-2">
                ‚ûï Agregar
              </a>
            </span>
          </div>
        </div>
      </div>
    {% endfor %}
  </div>
  {% endif %}

</div>
{% endblock %}

{% block extra_css %}
<style>
body { background: #0a0a0a; color: #fff; font-family: 'Poppins', sans-serif; }
#particles-bg { position:fixed; top:0; left:0; width:100%; height:100%; z-index:0; pointer-events:none; }

.list-group-item {
  border-left: 4px solid #00bfff;
  background: #111;
  transition: transform 0.2s ease, background 0.2s ease;
}
.list-group-item:hover {
  transform: translateX(4px);
  background: #1a1a1a;
}

.plato-item {
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}
.plato-item:hover {
  transform: scale(1.02);
  box-shadow: 0 0 15px #39ff14;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Filtro de b√∫squeda
document.getElementById("buscador")?.addEventListener("input", function() {
  const filtro = this.value.toLowerCase();
  document.querySelectorAll(".plato-item").forEach(item => {
    const texto = item.innerText.toLowerCase();
    item.style.display = texto.includes(filtro) ? "block" : "none";
  });
});

// Part√≠culas de fondo
const canvas = document.getElementById('particles-bg');
const ctx = canvas.getContext('2d');
let particles = [];
function resizeCanvas() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
window.addEventListener('resize', resizeCanvas);
resizeCanvas();

function initParticles(num=40){
  particles = [];
  for(let i=0;i<num;i++){
    particles.push({
      x: Math.random()*canvas.width,
      y: Math.random()*canvas.height,
      radius: Math.random()*2+1,
      color: ['#39ff14','#fffa00','#ff2e2e','#00bfff','#9966ff'][Math.floor(Math.random()*5)],
      dx: (Math.random()-0.5)*1,
      dy: (Math.random()-0.5)*1
    });
  }
}
initParticles();

function animateParticles(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  particles.forEach(p=>{
    p.x+=p.dx; p.y+=p.dy;
    if(p.x<0||p.x>canvas.width) p.dx*=-1;
    if(p.y<0||p.y>canvas.height) p.dy*=-1;
    ctx.beginPath();
    ctx.arc(p.x,p.y,p.radius,0,Math.PI*2);
    ctx.fillStyle=p.color;
    ctx.fill();
  });
  requestAnimationFrame(animateParticles);
}
animateParticles();
</script>
{% endblock %}
