{% extends "base.html" %}

{% block content %}
<div class="container py-4">

  <!-- Encabezado -->
  <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4">
    <h2 class="fw-bold text-white">
      üçΩ {% if pedido.mesa %}Mesa {{ pedido.mesa.numero }}{% else %}Para llevar{% endif %} ‚Äî Pedido #{{ pedido.id }}
    </h2>
    <a href="{% url 'lista_mesas' %}" class="btn btn-outline-light">
      ‚¨Ö Volver a Mesas
    </a>
  </div>

  <!-- Platos en el pedido -->
  <div class="mb-4">
    <h4 class="fw-bold text-white mb-3">üìã Platos en este pedido</h4>

    {% if pedido.detalles.all %}
      <ul class="list-group shadow rounded-3">
        {% for detalle in pedido.detalles.all %}
          <li class="list-group-item d-flex justify-content-between align-items-center bg-dark text-white">
            <div>
              <span class="fw-semibold">{{ detalle.plato.nombre }}</span>
              <small class="text-secondary">(x{{ detalle.cantidad }})</small>
            </div>
            <div>
              <span class="fw-bold text-success">S/. {{ detalle.subtotal|floatformat:2 }}</span>
              {% if pedido.estado == "abierto" %}
                <a href="{% url 'quitar_plato' pedido.id detalle.plato.id %}" 
                   class="btn btn-outline-danger btn-sm ms-2">
                  ‚ùå Quitar
                </a>
              {% endif %}
            </div>
          </li>
        {% endfor %}
      </ul>

      <div class="mt-3 d-flex flex-wrap justify-content-end align-items-center gap-2">
        <h5 class="mb-0 me-3 text-white">
          üí∞ Total: <strong class="text-info">S/. {{ pedido.total|floatformat:2 }}</strong>
        </h5>
        <a href="{% url 'imprimir_ticket' pedido.id 'cocina' %}" target="_blank" class="btn btn-outline-info btn-sm">
          üñ® Cocina
        </a>
        <a href="{% url 'imprimir_ticket' pedido.id 'cliente' %}" target="_blank" class="btn btn-outline-primary btn-sm">
          üßæ Cliente
        </a>
        {% if pedido.estado == "abierto" %}
          <a href="{% url 'cerrar_pedido' pedido.id %}" class="btn btn-danger btn-sm"
             onclick="return confirm('¬øCerrar este pedido y liberar la mesa?')">
            üîí Cerrar pedido
          </a>
        {% else %}
          <span class="badge bg-danger p-2"><i class="bi bi-lock-fill"></i> Pedido {{ pedido.estado }}</span>
        {% endif %}
      </div>
    {% else %}
      <p class="text-secondary mt-2">‚ö† No hay platos en este pedido a√∫n.</p>
    {% endif %}
  </div>

  {% if pedido.estado == "abierto" %}
  <!-- Buscador -->
  <div class="mb-3 sticky-top buscador-wrapper">
    <input type="text" id="buscador" class="form-control form-control-lg"
           placeholder="üîç Buscar plato o categor√≠a...">
  </div>

  <!-- Lista de platos -->
  <div id="lista-platos" class="row g-3 scroll-container">
    {% for plato in platos %}
      <div class="col-12 col-md-6 plato-card" data-nombre="{{ plato.nombre|lower }}" data-categoria="{{ plato.categoria.nombre|lower }}">
        <div class="card shadow border-0 bg-secondary text-white">
          <div class="card-body d-flex justify-content-between align-items-center">
            <span class="fw-semibold">{{ plato.nombre }}</span>
            <span>
              <span class="text-warning fw-bold">S/. {{ plato.precio|floatformat:2 }}</span>
              <a href="{% url 'agregar_plato' pedido.id plato.id %}" class="btn btn-success btn-sm ms-2">
                ‚ûï
              </a>
            </span>
          </div>
        </div>
      </div>
    {% endfor %}
  </div>
  {% endif %}

</div>
{% endblock %}

{% block extra_css %}
<style>
body {
  background: #0b1522; /* Azul oscuro estable */
  color: #fff;
  font-family: 'Poppins', sans-serif;
}

/* Contenedor scroll */
.scroll-container {
  max-height: 55vh;
  overflow-y: auto;
  padding-right: 5px;
}

/* Buscador sticky con fondo oscuro */
.buscador-wrapper {
  top: 70px;
  background: #0b1522;
  z-index: 10;
  padding: 8px 0;
  border-bottom: 1px solid #1e2a38;
}

/* Cards de platos */
.card {
  transition: transform 0.2s ease, box-shadow 0.2s ease;
  border-radius: 12px;
}
.card:hover {
  transform: scale(1.02);
  box-shadow: 0 0 12px rgba(0, 191, 255, 0.4);
}

/* Scroll personalizado */
.scroll-container::-webkit-scrollbar {
  width: 6px;
}
.scroll-container::-webkit-scrollbar-thumb {
  background: #00bfff;
  border-radius: 3px;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Filtro de b√∫squeda (por nombre y categor√≠a)
document.getElementById("buscador")?.addEventListener("input", function () {
  const filtro = this.value.toLowerCase();
  document.querySelectorAll(".plato-card").forEach(card => {
    const nombre = card.dataset.nombre;
    const categoria = card.dataset.categoria;
    card.style.display = (nombre.includes(filtro) || categoria.includes(filtro)) ? "block" : "none";
  });
});
</script>
{% endblock %}
